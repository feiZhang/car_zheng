<include file="Public:header"/>

<script>
function saveSaleInfo(saleType){
    $.dialog({
        id:"saleItemsResult",title:"销售结果",content:'正在处理中!<img src="__PUBLIC__/public/loading.gif" />',esc:true
    });
    
    $.ajax({
        type: "POST",
        url: "__ROOT__/Commodity/sale_selectitems" + saleType,
        data: $("#saleCommodityForm").serialize(),
        success: function(msg){
             $.dialog.get('saleItemsResult').content(msg);
             $.dialog.get('saleItemsResult').time(3000);
             $.dialog.get('select_card_info').close();
        }
     });
}
function submitSaleInfo(){
	//输入密码错误后，则无订单信息。
	//判断是否有次数消费。
	var haveSalInfo	= false;
	var html		= "";
	$("#coustomerHasTimesCard .saleTimesCard").each(function(i){
		if($(this).val()!=""){
			haveSalInfo	= true;
			html	+= $(this).attr("itemTitle") + "计次消费" + $(this).val() + "次<br />";
		}
	});
	//console.log(html);console.log($("#coustomerHasTimesCard .saleTimesCard"));
    if($("#commodityList input[type='checkbox']:checked").length>0 || haveSalInfo){
    	//无卡的，可以赊账，有卡的则不再赊账，直接记录到卡余额中。
        $.dialog({
            id:"saleAffirmInfo",title:"销售确认",content:'正在处理中!<img src="__PUBLIC__/public/loading.gif" />',esc:true,
            lock:true,
            ok:function(){
            	saveSaleInfo("");
            },
            okValue:"确定销售",
            cancelValue:"取消",
            cancel:function(){},
            initialize:function(){
                    var _this   = this;
                    $("#commodityList input[type='checkbox']:checked").each(function(i){
                    	var tid = $(this).val();
                    	html   += $("#commodityList input[name='commodity_title"+tid+"']").val() + $("#commodityList input[name='money"+tid+"']").val() + "元<br />";
                    });
                    if($("#saleCommodityForm input[name='customer_id']").length==0){
                    	_this.button({value: '赊账',callback: function () { saveSaleInfo("/sale_type/oncredit");}});
                    }
                    _this.content(html);
                }
        });
    }else{
        $.dialog({
            id:"showMessage",title:"提示",content:"没有选择要销售的商品!",esc:true,time:3000
        });
    }
}
$(function(){
	$("#inputCardNo").focus();
	//消费
	$("#cardExpense").click(function(){
	    $.dialog({
	    	id:"select_card_info",
	        title:"消费",
	        content:"等待查询卡信息!<img src='__PUBLIC__/public/loading.gif' />",
	        lock:true,
	        ok:function(){
	            submitSaleInfo();
	            return false;
	        },
	        okValue:"确定销售",
	        cancelValue:"取消",
	        cancel:function(){},
	        initialize:function(){
	                var _this  = this;
	                var url    = "__ROOT__/Card/card_select/type/sale/card_no/" + $("#inputCardNo").val();
	                $.get(url,function(html){
	                    _this.content(html);
	                    _this.position();
	                });
	            }
	    });
	});
	
    $("#cardTopUp").click(function(){
		if($("#inputCardNo").val()==0){
			$.dialog({title:"提醒",content:"充值必须有卡号",time:3000});
			return;
		}

        $.dialog({
        	id:"select_card_info",
            title:"卡充值",
            lock:true,
            content:"等待查询卡信息!<img src='__PUBLIC__/public/loading.gif' />",
            ok:function(){
                $.dialog({
                    id:"topUpResult",title:"充值结果",content:"正在处理中!<img src='__PUBLIC__/public/loading.gif' />"
                });

                $.ajax({
                       type: "POST",
                       url: "__ROOT__/Card/save_topup",
                       data: $("#saleCommodityForm").serialize(),
                       success: function(msg){
                    	   $.dialog.get('topUpResult').content(msg);
                    	   $.dialog.get('topUpResult').time(3000);
                       }
                    });
            },
            okValue:"确定充值",
            cancelValue:"取消",
            cancel:function(){},
            initialize:function(){
                var _this   = this;
                $.get("__ROOT__/Card/card_select/type/topup/card_no/" + $("#inputCardNo").val(),function(html){
                    _this.content(html);
                });
            }
        });
	});
	$("#cardSell").click(function(){
		$.dialog({
			title:"售卡",
			lock:true,
			ok:function(){
				var re  = true;
		        if($("#input_card_no").val()==0){
		            $.dialog({title:"提醒",content:"请填写卡号!",time:3000});
		            $("#input_card_no").focus();
		            return false;
		        }

                $.dialog({
                    id:"cardSellResult",title:"售卡结果",content:"正在处理中!<img src='__PUBLIC__/public/loading.gif' />"
                });
                
				$.ajax({
				   type: "POST",
				   url: "__ROOT__/Card/save_salecard",
				   data: $("#saleCardForm").serialize(),
				   success: function(msg){
					   $.dialog.get('cardSellResult').content(msg["info"]);
					   $.dialog.get('cardSellResult').time(3000);
					   
                       if(msg["status"]==0){
                    	   re = false;
                       }else{
                    	   $("#inputCardNo").val(msg["data"]);
                       }
				   },
				   dataType:"json"
				});
				return re;
			},
			okValue:"确定售卡",
			cancelValue:"取消",
			cancel:function(){},
			initialize:function(){
					var _this	= this;
					$.get("__ROOT__/Card/sale_card/card_no/" + $("#inputCardNo").val(),function(html){
						_this.content(html);
					});
				}
			});
	});
	
	/**
	商品寄存
    $("#saveCommodity").click(function(){
        if($("#inputCardNo").val()==0){
            $.dialog({title:"提醒",content:"充值必须有卡号",time:3000});
            return;
        }
        
        $.dialog({
            title:"物品寄存",
            lock:true,
            initialize:function(){
                    var _this   = this;
                    $.get("__ROOT__/Card/card_select/type/save_commodity/card_no/" + $("#inputCardNo").val(),function(html){
                        _this.content(html);
                    });
                }
            });
    });
	**/
	//追加无卡消费操作界面   追加此页面后，与弹出页面的form重复，导致冲突，所以关闭
/*     $.get("__ROOT__/Card/card_select/type/sale/card_no/",function(html){
    	$("#noCardExpense").html(html);
    });
 */
});
</script>
<div class="container" style="margin-top:5px;">
	<form class="form-inline">
		<label>输入卡号或车牌号或电话号码:</label>
		<div class="input-append">
			<input id="inputCardNo" type="text" placeholder="请输入卡号或车牌号或手机号" />
			<button id="cardExpense" class="btn" type="button">消费</button>
			<button id="cardTopUp" class="btn" type="button">充值</button>
			<button id="cardSell" class="btn" type="button">售卡</button>
			<!--  input id="saveCommodity" type="button" class="d-button d-state-highlight" value="寄存" \ >  -->
		</div>
	</form>
</div>

<div class="container" id="home_content">

</div>

<!-- 
<div class="qucik_sale">
    <div class="title-bar">
        无卡快捷消费
    </div>
	<div id="noCardExpense">
	    
	</div>
	<div>
	    <input type="button" value="提交销售" class="d-button d-state-highlight" onclick="submitSaleInfo();">
	    <input type="button" value="重置销售信息" class="d-button" onclick="javascript:document.getElementById('saleCommodityForm').reset();">
	</div>
</div>
-->

<include file="Public:footer"/>